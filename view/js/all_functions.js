function ajax(e,a,t,n=!0){$.ajax({url:e,type:"POST",data:JSON.stringify(a),contentType:"application/json; charset=utf-8",dataType:"json",success:t,async:n})}function addToCart(e){var a=$(e).prev()[0].defaultValue;if(userIsAuthorized()){ajax("/ajax/ajax_cart.php",{form_name:"add_to_cart",item_id:a,count:1},function(e){e.status||showMessageBox("Произошла ошибка при добавлении товара в корзину!",1),updateMiniCartStatus(e.total_sum,e.count)})}else{var t=$.cookie("bw-nodb-cart"),n=0,i=new RegExp(a+":[0-9]+");if(null==t)t=a+":1\n";else if(i.test(t)){var o=i.exec(t)[0];n=Number(o.substr(o.indexOf(":")+1))+1,t=t.replace(o,o.substr(0,o.indexOf(":")+1)+n)}else t+=a+":1\n";$.cookie("bw-nodb-cart",t,{path:"/",expires:1}),updateCartStatus()}var r=$(e).parent().parent().parent().find("#product-photo img"),s={position:"absolute",top:r.offset().top,left:r.offset().left},l=r.clone().css(s).appendTo(r.parent()),d=$("#basket #cart-icon").offset();animate_styles={top:d.top+5,left:d.left+20,width:"15px",height:"20px"},l.animate(animate_styles,1e3,function(){l.remove()})}function removeFromCart(e){var a=$(e).prev().val(),t=$(e).parent().parent();ajax("/ajax/ajax_cart.php",{form_name:"remove_from_cart",item_id:a},function(e){e.status?(t.slideUp(500,function(){t.remove()}),updateCartStatus()):showMessageBox("Возникла ошибка при удалении товара!",1)})}function removeFromNoDBCart(e){var a,t=$(e).prev().prev().val(),n=$(e).parent().parent(),i=new RegExp(t+":[0-9]+"),o=$.cookie("bw-nodb-cart");a=i.exec(o)[0],o=o.replace(a+"\n",""),$.cookie("bw-nodb-cart",o,{path:"/",expires:1}),n.slideUp(500,function(){n.remove()}),updateCartStatus()}function clearCart(){ajax("/ajax/ajax_cart.php",{form_name:"clear_cart"},function(e){e.status?($(".product").remove(),$("#sum-total h2:first-child span").html("0"),$("#sum-total h2:last-child span").html("0 BYR")):showMessageBox("Возникла ошибка при очистке корзины!",1)})}function clearNoDBCart(){$(".product").remove(),$("#sum-total h2:first-child span").html("0"),$("#sum-total h2:last-child span").html("0 BYR"),$.removeCookie("bw-nodb-cart",{path:"/"})}function minus(e){var a=$(e).next().next().children(),t=$(e).parent().parent().parent().parent().next().children("input[name=book_id]").val(),n=$(e).parent().parent().prev().prev().prev().text();(isCorrectNumber(a.val())?Number(a.val())>1&&a.val(Number(a.val())-1):a.val("1"),userIsAuthorized())?ajax("/ajax/ajax_cart.php",{form_name:"add_to_cart",item_id:t,count:-1},function(e){e.status||showMessageBox("Произошла ошибка при уменьшении количества товаров!",1)}):setProductsCountNoDB(t,a.val());n=new RegExp("[0-9]+").exec(n)[0],$(e).parent().parent().next().html("<strong>Итого:</strong> "+Number(n)*Number(a.val())+" BYR"),updateCartStatus()}function plus(e){var a=$(e).next().children(),t=$(e).parent().parent().parent().parent().next().children("input[name=book_id]").val(),n=$(e).parent().parent().prev().prev().prev().text();(isCorrectNumber(a.val())?a.val(Number(a.val())+1):a.val("1"),userIsAuthorized())?ajax("/ajax/ajax_cart.php",{form_name:"add_to_cart",item_id:t,count:1},function(e){e.status||showMessageBox("Произошла ошибка при увеличении количества товаров!",1)}):setProductsCountNoDB(t,a.val());n=new RegExp("[0-9]+").exec(n)[0],$(e).parent().parent().next().html("<strong>Итого:</strong> "+Number(n)*Number(a.val())+" BYR"),updateCartStatus()}function setProductsCountNoDB(e,a){var t,n=$.cookie("bw-nodb-cart");null!=(t=new RegExp(e+":[0-9]+").exec(n))&&(n=n.replace(t[0],e+":"+a),$.cookie("bw-nodb-cart",n,{path:"/",expires:1}))}function setProductsCount(e,a){}function isCorrectNumber(e){return!!new RegExp("^[0-9]+$").test(e)}function getCartStatusFromHTML(){for(var e=0,a=0,t=$("div.product div#product-description ul li:last-child"),n=$("div.product div#product-description ul li div#product-count div#count input"),i=0;i<t.length;i++)e+=Number(new RegExp("[0-9]+").exec(t[i].innerText)[0]),a+=Number(n[i].value);return{total_sum:e,count:a}}function getCartStatusFromCookies(){var e,a=$.cookie("bw-nodb-cart"),t={total_sum:0,count:0},n=0,i=0,o=/[0-9]+/gi;if(null!=a&&0!=a.length)for(;e=o.exec(a);)(n+1)%2!=0?ajax("/ajax/ajax_cart.php",{form_name:"get_book_price",item_id:e[0]},function(e){e.status&&(i=Number(e.price))},!1):(current_count=Number(e[0]),t.count+=current_count,t.total_sum+=current_count*i),n++;return t}function updateCartStatus(e,a){if(0!=$("#inside-content-body #basket").length){var t=getCartStatusFromHTML();$("#sum-total h2:last-child span").html(t.total_sum+" BYR"),$("#sum-total h2:first-child span").html(t.count),e=t.total_sum,a=t.count}else if(null==e&&null==a){e=(t=getCartStatusFromCookies()).total_sum,a=t.count}updateMiniCartStatus(e,a)}function updateMiniCartStatus(e,a){$("#basket #inside-basket p").html(e+" BYR"),$("#basket #count-of-goods").html(a)}function userIsAuthorized(){return 0!=$("div#user-profil").length}function proceedToCheckout(){location.href="/add-order"}window.onload=function(){var e=$("div#topmenu ul li div.drop-down-menu").prev(),a=$("div#topmenu ul li div.drop-down-menu");e.bind({click:function(e){e.preventDefault()},mouseover:function(e){var a=$(e.target);a.toggleClass("active"),a.next().toggleClass("hidden")},mouseout:function(e){var a=$(e.target);$(e.relatedTarget).hasClass("drop-down-menu")||$(e.relatedTarget).hasClass("dd-ul")||$(e.relatedTarget).hasClass("dd-li")||$(e.relatedTarget.parentNode).hasClass("dd-li")||(a.toggleClass("active"),a.next().toggleClass("hidden"))}}),a.bind("mouseleave",function(e){var a=$(e.target),t=a.prop("tagName");"DIV"==t?(a.toggleClass("hidden"),a.prev().toggleClass("active")):"A"==t&&((a=a.parent().parent().parent()).toggleClass("hidden"),a.prev().toggleClass("active"))})};var tmr1=null;function getResults(){null!=tmr1&&clearTimeout(tmr1),tmr1=setTimeout(animateDropResults,1e3)}function animateDropResults(){var e=$("#content-head #search input[type=text]").val();drop_list=$("#search-results"),0!=e.length?ajax("/ajax/ajax_search.php",{search_string:e},function(a){a.status?($("#content-head #search-results #result-lines").html(a.html),$("#content-head #search-results #more-results a").attr("href","/search/"+e+"/"),"none"==drop_list.css("display")&&drop_list.slideDown(500)):"none"!=drop_list.css("dislplay")&&(drop_list.css("margin-top","0"),drop_list.slideUp(500))}):(drop_list.css("margin-top","0"),drop_list.slideUp(500))}function goToLink(e){e=$(e),window.location.href=e.children(".link").text()}function goLogin(){var e=$("#inside-mini-profil input[name=login]").val(),a=$("#inside-mini-profil input[name=pass]").val();void 0===e||void 0===a?showMessageBox("Ошибка! Поля не найдены! Попробуйте\nобновить страницу и авторизоваться заново!",1):0!=e.length&&0!=a.length?ajax("/ajax/login.php",{login:e,password:a,remember:1},function(e){0!=e.code?showMessageBox(e.message,1):($("#left-block").html(e.html.left_block),$("#mini-profil").html(e.html.mp),$("#topmenu ul li:last-child").prev().html(""),$("#topmenu ul li:last-child").html('<li><a href="/pc/my-contacts">Личный кабинет</li>'),clearNoDBCart())}):showMessageBox("Ошибка! Не все поля заполнены!",1)}function goLogout(){ajax("/ajax/logout.php",{logout:!0},function(e){0!=e.code?showMessageBox(e.message,1):($("#left-block").html(e.html.left_block),$("#mini-profil").html(e.html.mp),$("#topmenu ul li:last-child").html('<li><a href="/cart/">Корзина</a></li><li><a href="/registration">Регистрация</li>'))})}function showMessageBox(e,a=0){var t=$("#message-box"),n="ИНФОРМАЦИЯ";1==a?(t.addClass("error"),n="ОШИБКА"):t.removeClass("error"),t.find("#message-title").html(n),t.children("#message-body").html(e),t.removeClass("hidden"),t.animate({bottom:"7%",opacity:"1"},300)}function hideMessageBox(){var e=$("#message-box"),a={bottom:0-e.outerHeight()+"px",opacity:"0"};e.animate(a,300,function(){e.addClass("hidden")})}function setDiliveryDate(e){(e=$(e)).parent().find("li.active").toggleClass("active"),e.toggleClass("active")}function setFormat(e){var a=(e=$(e)).parent().parent().parent();if(!e.hasClass("active")){var t=a.find(".format-description.fd-"+e.parent().find(".active").val());e.parent().find(".active").toggleClass("active");var n=t.prev();0!=n.length&&n.hasClass("fd-heading")&&n.toggleClass("hidden"),0!=t.length&&t.toggleClass("hidden"),e.toggleClass("active"),0!=(n=(t=a.find(".format-description.fd-"+e.val())).prev()).length&&n.hasClass("fd-heading")&&n.toggleClass("hidden"),0!=t.length&&t.toggleClass("hidden")}}function setOnlinePaymentFormat(e){(e=$(e)).hasClass("active")||(e.parent().find(".active").toggleClass("active"),e.toggleClass("active"))}function addBooksFromOrderToCart(e){ajax("/ajax/ajax_order.php",{mode:"add_books_from_order_to_cart",order_id:(e=$(e)).parent().find("input[name=item_id]").val()},function(e){e.status?(showMessageBox("Товары успешно добавлены в корзину!"),updateMiniCartStatus(e.total_sum,e.count)):alert(e.message)})}function cacncelOrder(e){ajax("/ajax/ajax_order.php",{mode:"cancel_order",order_id:(e=$(e)).parent().find("input[name=item_id]").val()},function(a){if(a.status){var t=e.parent().parent().prev().find("li:last-child");t.html(t.html().substr(0,t.html().indexOf("</strong>")+9)+" отменен."),e.parent().find("input[name=edit]").toggleClass("hidden"),e.parent().find("input[name=delete]").toggleClass("hidden");var n=e.parent().parent().parent(),i=n.attr("class");i=i.replace(new RegExp(/o-status-[0-9]/),"o-status-5"),n.attr("class",i)}else alert(a.message)})}function setRating(e){var a=$(e),t=a.val();if(1==t&&1==getRating(a.parent()))resetRating(e);else{resetRating(e);for(var n=t;n>0;n--)a.toggleClass("active"),a=a.prev()}}function getRating(e){return e.children("li.active").length}function resetRating(e){$(e).parent().children("li").removeClass("active")}function resetReview(){var e=$("#reviews #review.my");e.find("#review-head #review-info ul li").removeClass("active"),e.find("#review-body textarea").val("")}function addReviewToHTML(e,a,t){var n=$("#reviews #review.my").clone(),i=$("#user-profil #user-name p:first-child").text(),o=$("#user-profil #user-name p:last-child").text();n.removeClass("my");var r=n.find("#review-head #review-control");r.find("input[type=button]#ok").toggleClass("hidden"),r.find("input[type=button]#edit").removeClass("hidden"),n.find("#review-head #review-info p").html(i+"<br />"+o),n.find("#review-head #review-info ul li").attr("onclick",""),n.find("#review-body textarea").attr("readonly",!0),n.find("#review-head #review-info input[name=item_id]").val(e),resetReview(),$("#reviews #review.my").after(n)}function expandTextarea(){var e=$("#reviews #review.my #review-body textarea[name=review-text]"),a=Math.ceil(e.val().length/87);0==a&&(a=1),a!=Number(e.attr("rows"))&&e.attr("rows",a)}function editReview(e){var a=$(e).parent().parent().parent().parent(),t=a.find("#review-head #review-control");a.toggleClass("can-be-edited"),a.find("#review-body textarea[name=review-text]").removeAttr("readonly"),a.find("#review-head #review-info ul li").attr("onclick","setRating(this);"),t.find("input[type=button]#ok").toggleClass("hidden"),t.find("input[type=button]#edit").toggleClass("hidden"),t.find("input[type=button]#cancel").attr("onclick","blockReviewForEditing(this);")}function removeReview(e){var a=$(e).parent().parent().parent().parent();ajax("/ajax/validator.php",{mode:"remove_review",id:a.find("#review-head #review-info input[name=item_id]").val()},function(e){e.status?a.remove():alert(e.message)})}function blockReviewForEditing(e){var a=$(e),t=a.find("#review-head #review-control");a.removeClass("can-be-edited"),console.log(a),a.find("#review-body textarea[name=review-text]").attr("readonly",!0),a.find("#review-head #review-info ul li").attr("onclick",""),t.find("input[type=button]#ok").toggleClass("hidden"),t.find("input[type=button]#edit").toggleClass("hidden"),t.find("input[type=button]#cancel").attr("onclick","removeReview(this);")}function sendBookInfo(e){var a;a={id:$("#personal-data input[name=item_id]").val(),title:$("#personal-data input[name=title]").val(),author:$("#personal-data input[name=author]").val(),genre_id:Number($("#personal-data select[name=genre_code] option:selected").val()),language:$("#personal-data input[name=language]").val(),keywords:$("#personal-data input[name=keywords]").val(),series:$("#personal-data input[name=series]").val(),rightholder:$("#personal-data input[name=rightholder]").val(),age_restrictions:$("#personal-data input[name=age_restrictions]").val(),isbn:$("#personal-data input[name=isbn]").val(),price:$("#personal-data input[name=price]").val(),count:$("#personal-data input[name=count]").val(),annotation:$("#personal-data textarea[name=annotation]").val()},e?(a.mode="book_edit",ajax("/ajax/validator.php",a,function(e){e.status?showMessageBox("Информация о товаре обновлена!"):showMessageBox(e.message,1)})):(a.mode="book_new",ajax("/ajax/validator.php",a,function(e){e.status?showMessageBox("Товар успешно добавлен!"):showMessageBox(e.message,1)}))}function sendInfoBlock(e){var a;a={id:$("#personal-data input[name=item_id]").val(),title:$("#personal-data input[name=title]").val(),access_level:$("#personal-data input[name=access_level]").val(),content:$("#personal-data textarea[name=info_block_content]").val()},e?(a.mode="i_block_edit",ajax("/ajax/validator.php",a,function(e){e.status?showMessageBox("Информационный блок изменен!\nДля отображения изменений перезагрузите страницу!"):showMessageBox(e.message,1)})):(a.mode="i_block_new",ajax("/ajax/validator.php",a,function(e){e.status?showMessageBox("Информационный блок успешно добавлен!\nДля отображения перезагрузите страницу!"):showMessageBox(e.message,1)}))}function sendMyContacts(){var e={mode:"my_contacts_edit",firstname:$("#personal-data input[name=firstname]").val(),lastname:$("#personal-data input[name=lastname]").val(),email:$("#personal-data input[name=email]").val(),phone_number:$("#personal-data input[name=phone]").val(),password:$("#personal-data input[name=password]").val(),repassword:$("#personal-data input[name=repassword]").val(),gender:$("#personal-data input#male").prop("checked")?$("#personal-data input#male").val():$("#personal-data input#female").val(),state:$("#delivery-data input[name=state]").val(),city:$("#delivery-data input[name=city]").val(),address:$("#delivery-data input[name=address]").val(),zip_code:$("#delivery-data input[name=zip_code]").val()};void 0===e.state&&(e.state=""),void 0===e.city&&(e.city=""),void 0===e.address&&(e.address=""),void 0===e.zip_code&&(e.zip_code=""),ajax("/ajax/validator.php",e,function(e){e.status?showMessageBox("Информация успешно обновлена!"):showMessageBox(e.message,1)})}function sendRegisterInfo(){var e={mode:"register",firstname:$("#personal-data input[name=firstname]").val(),lastname:$("#personal-data input[name=lastname]").val(),email:$("#personal-data input[name=email]").val(),phone_number:$("#personal-data input[name=phone]").val(),password:$("#personal-data input[name=password]").val(),repassword:$("#personal-data input[name=repassword]").val(),gender:$("#personal-data input#male").prop("checked")?$("#personal-data input#male").val():$("#personal-data input#female").val()};$("#personal-data input[name=i-agree]").prop("checked")?ajax("/ajax/validator.php",e,function(e){e.status?showMessageBox("Вы успешно зарегистрированы!"):showMessageBox(e.message,1)}):showMessageBox("Вначале нужно подтвердить свое согласие с правилами проекта!",1)}function sendReview(e){var a=$(e).parent().parent().parent().parent(),t={id:a.find("#review-head #review-info input[name=item_id]").val(),book_id:Number($("#general-information #product-information ul li[name=item_id]").text()),rating:getRating(a.find("#review-info ul")),text:a.find("#review-body textarea[name=review-text]").val()};0==t.text.length?showMessageBox("Для начала введите то, что думаете о книге!",1):a.hasClass("my")?(t.mode="add_review",ajax("/ajax/validator.php",t,function(e){e.status?addReviewToHTML(e.item_id,t.rating,t.text):showMessageBox(e.message,1)})):(t.mode="edit_review",ajax("/ajax/validator.php",t,function(e){e.status?blockReviewForEditing(a):showMessageBox(e.message,1)}))}function sendOrder(){var e={mode:"order_add",dilivery_method:$("#add-order #dilivery-format .format-selection ul li.active").val(),payment_method:$("#add-order #payment-format .format-selection ul li.active").val(),payment_system:null,date_of_dilivery:$("#add-order #dilivery-date ul li.active").val(),time_of_dilivery:$("#add-order #dilivery-time select option:selected").val(),user_info:null};0!=$("#add-order #payment-format .format-description.fd-"+e.payment_method).length&&(e.payment_system=$("#add-order #payment-format .format-description.fd-"+e.payment_method+" ul li.active").val());var a=userIsAuthorized();if(!a){e.mode="add_order_for_nodb_user";var t=$("#add-order #personal-data");e.user_info={firstname:t.find("input[name=firstname]").val(),lastname:t.find("input[name=lastname]").val(),email:t.find("input[name=e-mail]").val(),phone:t.find("input[name=phone]").val(),state:t.find("input[name=region]").val(),city:t.find("input[name=city]").val(),address:t.find("input[name=address]").val(),zip_code:t.find("input[name=postcode]").val()}}a||""!=e.user_info.firstname&&""!=e.user_info.lastname&&""!=e.user_info.email&&""!=e.user_info.phone&&""!=e.user_info.state&&""!=e.user_info.city&&""!=e.user_info.address&&""!=e.user_info.zip_code?ajax("/ajax/ajax_order.php",e,function(e){e.status?showMessageBox("Ваш заказ добавлен в очередь!"):showMessageBox(e.message,1)}):showMessageBox("Ошибка! Не все поля заполнены!",1)}function sendUser(e){var a={mode:e?"edit_user":"add_user",id:$("#personal-data input[name=item_id]").val(),firstname:$("#personal-data input[name=firstname]").val(),lastname:$("#personal-data input[name=lastname]").val(),email:$("#personal-data input[name=email]").val(),phone_number:$("#personal-data input[name=phone]").val(),level:$("#personal-data select[name=users_group] option:selected").val(),password:$("#personal-data input[name=password]").val(),repassword:$("#personal-data input[name=repassword]").val(),gender:$("#personal-data input[name=gender]:checked").val(),state:$("#delivery-data input[name=state]").val(),city:$("#delivery-data input[name=city]").val(),address:$("#delivery-data input[name=address]").val(),zip_code:$("#delivery-data input[name=zip_code]").val()};null==a.state&&(a.state=""),null==a.city&&(a.city=""),null==a.address&&(a.address=""),null==a.zip_code&&(a.zip_code=""),a.password!=a.repassword?showMessageBox("Введенные пароли не совпадают!",1):!(a.state.length>0||a.city.length>0||a.address.length>0||a.zip_code.length>0)||0!=a.state.length&&0!=a.city.length&&0!=a.address.length&&0!=a.zip_code?ajax("/ajax/validator.php",a,function(a){a.status&&!e?showMessageBox("Пользователь успешно добавлен!"):a.status&&e?showMessageBox("Информация о пользователе успешно обновлена!"):showMessageBox(a.message,1)}):showMessageBox("Заполните все данные для доставки или пропустите вовсе!",1)}
